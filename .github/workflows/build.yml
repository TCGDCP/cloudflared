name: Build cloudflared Multi-Arch Binaries and Create Release

on:
  workflow_dispatch:

jobs:
  build:
    # ä½¿ç”¨ strategy matrix æ¥å®šä¹‰è¦æ„å»ºçš„æ¶æ„
    strategy:
      fail-fast: false
      matrix:
        # å®šä¹‰è¦æ„å»ºçš„æ“ä½œç³»ç»Ÿå’Œæ¶æ„ç»„åˆ
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: darwin
            goarch: amd64
          # æ›´å¤šæ¶æ„ç»„åˆ...

    runs-on: ubuntu-latest # ä½¿ç”¨æ ‡å‡†çš„ Ubuntu Runner

    steps:
      - name: â¬‡ï¸ Checkout code (æ£€å‡ºä»£ç )
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Go (è®¾ç½® Go ç¯å¢ƒ)
        uses: actions/setup-go@v5
        with:
          # ä½¿ç”¨ cloudflared æ¨èçš„ Go ç‰ˆæœ¬
          go-version: '1.25.3'

      # (å¯é€‰) å¦‚æœç¼–è¯‘è¿‡ç¨‹ä¸­æœ‰Cä»£ç ä¾èµ–ï¼Œå¯èƒ½éœ€è¦å®‰è£…Cäº¤å‰ç¼–è¯‘å·¥å…·
      # - name: Install C Cross-Compiler (for CGO)
      #   if: ${{ matrix.goos != 'windows' && matrix.goos != 'darwin' }}
      #   run: |
      #     sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: ğŸ”¨ Build cloudflared for ${{ matrix.goos }}-${{ matrix.goarch }} (æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶)
        # Go äº¤å‰ç¼–è¯‘çš„æ ¸å¿ƒï¼šè®¾ç½®ç¯å¢ƒå˜é‡ GOOS å’Œ GOARCH
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0 # ç¦ç”¨ CGO è¿›è¡Œé™æ€ç¼–è¯‘ï¼Œé€šå¸¸æ›´å®‰å…¨
        run: |
          # å®šä¹‰è¾“å‡ºæ–‡ä»¶åï¼ŒåŒ…å« OS å’Œ Arch
          output_name="cloudflared-${{ matrix.goos }}-${{ matrix.goarch }}"
          if [ "${{ matrix.goos }}" == "windows" ]; then
            output_name="${output_name}.exe"
          fi

          # æ‰§è¡Œç¼–è¯‘å‘½ä»¤ (å‡è®¾ cloudflared å…¥å£åœ¨ ./cmd/cloudflared)
          go build -ldflags "-s -w" -o ./$output_name ./cmd/cloudflared

      - name: ğŸ“¦ Archive and Upload Artifact (ä¸Šä¼ æ„å»ºäº§ç‰©)
        uses: actions/upload-artifact@v4
        with:
          name: cloudflared-binaries-${{ matrix.goos }}-${{ matrix.goarch }}
          path: cloudflared-*

  release:
    needs: build # ç¡®ä¿ build æˆåŠŸåæ‰è¿è¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Download all artifacts (ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©)
        uses: actions/download-artifact@v4
        with:
          path: artifacts # ä¸‹è½½åˆ° artifacts æ–‡ä»¶å¤¹

      - name: ğŸ“ Release Tag and Type (ç¡®å®š Release æ ‡ç­¾å’Œç±»å‹)
        id: release_info
        run: |
          # æ ¼å¼ä¸ºYYYY.MM.DD
          TAG_NAME="$(date -u +'%Y.%m.%d')"
          BODY_TEXT="å®˜æ–¹ç¼–è¯‘ç‰ˆæœ¬"
          echo "å°†åˆ›å»ºæ­£å¼Releaseï¼Œæ ‡ç­¾åä¸º: $TAG_NAME"

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "body_text=$BODY_TEXT" >> $GITHUB_OUTPUT


      - name: ğŸ·ï¸ Create GitHub Release (åˆ›å»º GitHub Release)
        uses: softprops/action-gh-release@v2
        with:
          # ä½¿ç”¨åŠ¨æ€æˆ– Tag åç§°
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          # ç¡®ä¿æ‰‹åŠ¨ Release æŒ‡å‘å½“å‰çš„ Commit SHA
          target_commitish: ${{ github.sha }}
          # ç§»é™¤ draft å’Œ prereleaseï¼Œä¾èµ– action çš„é»˜è®¤å€¼ (false)
          body: ${{ steps.release_info.outputs.body_text }}
          files: artifacts/**/cloudflared-* # ä¸Šä¼  artifacts ç›®å½•ä¸‹çš„æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # éœ€è¦ Secrets æƒé™æ¥åˆ›å»º Release
